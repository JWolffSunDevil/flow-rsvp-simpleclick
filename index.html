<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flow Tapper + Peripheral RSVP (Ultra-Fast, Low-Contrast)</title>
<style>
  :root {
    --bg:#ffffff; --fg:#0f1720; --muted:#4b5563; --accent:#0b5fff;
    --border:#e5e7eb; --pill:#111827; --pill-border:#cbd5e1;
    /* lower this to move digits even closer to the dot */
    --rsvp-offset: 90px;
  }
  html,body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  #app { display:flex; align-items:center; justify-content:center; height:100%; }
  .card { width:min(900px,92vw); border:1px solid var(--border); border-radius:16px; padding:28px;
    box-shadow:0 10px 30px rgba(0,0,0,.07); background:linear-gradient(180deg,#ffffff 0%,#f9fafb 100%); }
  h1 { margin:0 0 6px 0; font-size:22px; color:#0b1220; }
  p { color:var(--muted); line-height:1.5; }
  .center { text-align:center; }
  .mid { font-size:36px; }
  .hint { font-size:14px; color:#6b7280; }
  .pill { padding:8px 12px; border-radius:999px; border:1px solid var(--pill-border); background:#f8fafc; color:#111827; }
  .layout {
    position:relative; height:60vh; min-height:420px; display:flex; align-items:center; justify-content:center;
    border:1px dashed var(--pill-border); border-radius:16px; margin:20px 0; background:#fff;
  }
  /* Gray RSVP box; digits/masks are drawn to a canvas inside */
  .rsvp-wrap {
    position:absolute;
    bottom:calc(50% + var(--rsvp-offset));
    left:50%;
    transform:translateX(-50%);
    width:360px; height:140px;
    background:#cfd1d4;           /* close to digit gray */
    border:1px solid #c9ccd0;
    border-radius:12px;
    box-shadow:inset 0 0 10px rgba(0,0,0,0.05);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  #rsvpCanvas { width:100%; height:100%; display:block; }
  .dot {
    width:84px; height:84px; border-radius:50%; background:var(--accent); opacity:.25;
    transition:transform .08s, opacity .08s; transform:scale(1);
  }
  .dot.flash { opacity:.95; transform:scale(1.08); }
  .btn { display:inline-block; background:#111827; border:1px solid #0f1720; color:#ffffff;
    padding:10px 14px; border-radius:10px; cursor:pointer; }
  .btn:hover{ filter:brightness(1.1);}
  .row { display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:12px;}
  .two { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .choice { padding:14px; border:1px solid var(--pill-border); border-radius:12px; text-align:center; font-size:28px; cursor:pointer; user-select:none; background:#fff; }
  .choice:hover { outline:2px solid #d1d5db; }
  input[type="text"], input[type="number"], select {
    width:260px; padding:10px 12px; border-radius:10px; border:1px solid var(--pill-border); background:#fff; color:#0f1720;
  }
  .form-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0;}
  .opt{ display:flex; gap:8px; align-items:center; }
  .tiny{ font-size:12px; color:#6b7280; }
</style>
</head>
<body>
<div id="app"><div class="card"><div id="screen"></div></div></div>

<script>
(function(){
  // ===== CONFIG =====
  const ROUNDS = [
    {name:"Easy",   bpm:60,  rsvpHz:120, targetPool:[3,8,12,17,20]},
    {name:"Medium", bpm:90,  rsvpHz:120, targetPool:[2,5,11,14,19]},
    {name:"Hard",   bpm:120, rsvpHz:120, targetPool:[1,6,9,15,18]},
  ];
  const ROUND_DURATION_RANGE_MS = [15000, 60000];
  const TARGETS_PER_ROUND = 6;
  const TARGET_FIRST_MS   = [3000,5000];
  const TARGET_GAP_MS     = [7000,11000];

  // RSVP micro-flash — harder to read
  const SHOW_FRAMES = 1;
  const MASK_FRAMES = 7;        // more mask frames
  const DIGIT_ALPHA = 0.09;     // lower contrast
  const DIGIT_JITTER = 2;       // px jitter
  const DIGIT_BLUR_PX = 3.2;    // more blur
  const RING_RADIUS = 36;
  const NOISE_STROKES = 30;     // denser mask
  const DIGIT_GRAY = '#7b8085'; // close to box gray

  // Keys
  const YES_KEY="KeyF", NO_KEY="KeyJ", LEFT_KEY="KeyF", RIGHT_KEY="KeyJ";
  const LIKERT5=["Digit1","Digit2","Digit3","Digit4","Digit5"];

  // Likert labels
  const LABELS_CONF_5 = ["1 · Not at all","2 · Slightly","3 · Moderately","4 · Mostly","5 · Very"];
  const LABELS_CONC_5 = ["1 · Extremely","2 · Very","3 · Moderately","4 · Slightly","5 · Not at all"];
  const LABELS_LOST_5 = ["1 · Not at all","2 · Slightly","3 · Somewhat","4 · Mostly","5 · Completely"];

  // ===== STATE =====
  const S = {
    pid:"", phase:"pid", roundIndex:-1,
    rafId:0, keyHandler:null, keyTimeout:null,
    roundStart:0, endAt:0, nextBeatAt:0, beatInterval:600,
    nextRSVPAt:0, rsvpInterval:40,
    currentDigit:null, phaseFrame:0,
    targets:[], rsvpShown:new Array(21).fill(0),
    transitioning:false, roundMeta:{}, log:[],
    demo:{ gender:"", age:"", race:"" }
  };

  // ===== UTILS =====
  const now = ()=>performance.now();
  const randint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const sample = arr=>arr[Math.floor(Math.random()*arr.length)];
  const screen=document.getElementById('screen');
  const html=(s,...v)=>s.map((x,i)=>x+(v[i]??'')).join('');

  // Key handling
  window.addEventListener('keydown', e=>{
    const block=["Space","KeyF","KeyJ","Digit1","Digit2","Digit3","Digit4","Digit5"];
    if (typeof S.keyHandler==='function' && block.includes(e.code)) e.preventDefault();
    if (typeof S.keyHandler==='function') S.keyHandler(e);
  }, {passive:false});
  function setKeyHandler(allowed, ms, cb){
    clearKeyHandler();
    S.keyHandler = e=>{ if (!allowed || allowed.includes(e.code)) { clearKeyHandler(); cb(e.code); } };
    if (ms>0) S.keyTimeout=setTimeout(()=>{ clearKeyHandler(); cb(null); }, ms);
  }
  function clearKeyHandler(){ if (S.keyTimeout){ clearTimeout(S.keyTimeout); S.keyTimeout=null; } S.keyHandler=null; }
  function cancelLoop(){ if (S.rafId){ cancelAnimationFrame(S.rafId); S.rafId=0; } }

  // Targets schedule
  function scheduleTargets(duration, pool){
    const out=[]; let t=randint(...TARGET_FIRST_MS);
    for (let i=0;i<TARGETS_PER_ROUND;i++){
      out.push({at:t, digit: sample(pool), shown:false});
      t+=randint(...TARGET_GAP_MS);
      if (t>duration-1000) break;
    }
    return out;
  }

  // ===== PID =====
  function pidPrompt(){
    cancelLoop(); clearKeyHandler(); S.phase='pid';
    screen.innerHTML = html`
      <h1>Enter Participant ID</h1>
      <p class="hint">Type your ID, then press Enter.</p>
      <div class="center" style="margin-top:10px">
        <input id="pid" type="text" placeholder="e.g., P001" autofocus />
      </div>`;
    const el=document.getElementById('pid'); el.focus();
    S.keyHandler = e=>{
      if (e.code==='Enter'){
        const v=el.value.trim();
        if (v.length>0){ S.pid=v; intro(); }
      }
    };
  }

  // ===== INTRO =====
  function intro(){
    cancelLoop(); clearKeyHandler(); S.phase='intro';
    screen.innerHTML = html`
      <h1>Tap the dot in rhythm</h1>
      <p>Press <strong>SPACE</strong> when the dot flashes. Numbers will flash just above the dot—extremely briefly.</p>
      <div class="layout">
        <div class="rsvp-wrap">
          <canvas id="rsvpCanvas" width="720" height="280"></canvas>
        </div>
        <div class="dot" id="dot"></div>
      </div>
      <div class="center"><button class="btn" id="start">Start</button></div>`;
    document.getElementById('start').onclick = ()=> startNextRound();
  }

  function startNextRound(){
    if (S.transitioning) return;
    S.transitioning=true; S.roundIndex++;
    if (S.roundIndex>=ROUNDS.length) { demographics(); return; }
    setTimeout(()=>{ S.transitioning=false; runRound(ROUNDS[S.roundIndex]); }, 0);
  }

  // ===== ROUND (canvas RSVP in gray box) =====
  function runRound(cfg){
    cancelLoop(); clearKeyHandler(); S.phase='round';
    S.roundStart = now();
    const runDuration = randint(...ROUND_DURATION_RANGE_MS);
    S.endAt      = S.roundStart + runDuration;

    S.beatInterval = 60000/cfg.bpm;
    S.nextBeatAt   = S.roundStart + S.beatInterval;
    S.rsvpInterval = Math.max(8, Math.round(1000/cfg.rsvpHz));
    S.nextRSVPAt   = S.roundStart + S.rsvpInterval;

    S.targets     = scheduleTargets(runDuration, cfg.targetPool);
    S.rsvpShown   = new Array(21).fill(0);
    S.currentDigit = null;
    S.phaseFrame = 0;

    S.log.push({pid:S.pid, type:'ROUND_START', round:S.roundIndex, roundName:cfg.name, ts:0,
                bpm:cfg.bpm, rsvpHz:cfg.rsvpHz, plannedMs:runDuration});

    screen.innerHTML = html`
      <div class="row">
        <div class="pill">${cfg.name}</div>
        <div class="hint">Press SPACE</div>
      </div>
      <div class="layout">
        <div class="rsvp-wrap">
          <canvas id="rsvpCanvas" width="720" height="280"></canvas>
        </div>
        <div id="dot" class="dot"></div>
      </div>`;

    const dot   = document.getElementById('dot');
    const canvas = document.getElementById('rsvpCanvas');
    const ctx = canvas.getContext('2d');
    const cw=canvas.width, ch=canvas.height;
    const cx = cw/2, cy = ch/2;             // center of the box
    const digitBaseY = cy + 56;             // baseline inside the box

    ctx.textAlign='center'; ctx.textBaseline='alphabetic';
    ctx.font='220px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';

    setKeyHandler(["Space"], 0, ()=>{
      const t=now();
      S.log.push({pid:S.pid, type:'TAP', round:S.roundIndex, roundName:cfg.name, ts:Math.round(t-S.roundStart)});
    });

    function drawMask(){
      // ring (close gray, low alpha)
      ctx.save();
      ctx.globalAlpha = 0.26;
      ctx.lineWidth = 8;
      ctx.strokeStyle = '#8a8f94';
      ctx.beginPath();
      ctx.arc(cx, cy-40, RING_RADIUS, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();

      // noise strokes (close gray)
      ctx.save();
      ctx.globalAlpha = 0.20;
      ctx.strokeStyle = '#7f8489';
      for (let i=0;i<NOISE_STROKES;i++){
        const rx = cx + (Math.random()*220-110);
        const ry = (cy-40) + (Math.random()*120-60);
        const len = Math.random()*18+6;
        const ang = Math.random()*Math.PI*2;
        ctx.beginPath();
        ctx.moveTo(rx, ry);
        ctx.lineTo(rx + Math.cos(ang)*len, ry + Math.sin(ang)*len);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawDigit(d){
      // slight blur & jitter, very low alpha, gray close to background
      const jx = (Math.random()*2*DIGIT_JITTER - DIGIT_JITTER);
      const jy = (Math.random()*2*DIGIT_JITTER - DIGIT_JITTER);
      ctx.save();
      ctx.filter = `blur(${DIGIT_BLUR_PX}px)`;
      ctx.globalAlpha = DIGIT_ALPHA;
      ctx.fillStyle = DIGIT_GRAY;
      ctx.fillText(String(d), cx + jx, digitBaseY + jy);
      ctx.restore();
    }

    function loop(){
      const t = now();
      if (t>=S.endAt){ cancelLoop(); clearKeyHandler(); return postRound(cfg, runDuration); }

      // jittered beats (FIXED: no leaked vars)
      while (t>=S.nextBeatAt){
        const jitter = 0.35;
        const factor = 1 + (Math.random()*2 - 1) * jitter;
        S.nextBeatAt = t + S.beatInterval * factor;
        dot.classList.add('flash'); setTimeout(()=>dot.classList.remove('flash'),120);
        S.log.push({pid:S.pid, type:'BEAT', round:S.roundIndex, roundName:cfg.name, ts:Math.round(t-S.roundStart)});
      }

      // new digit on interval
      while (t>=S.nextRSVPAt){
        S.nextRSVPAt += S.rsvpInterval;
        let digit = randint(1,20);
        const elapsed = t - S.roundStart;
        for (const tgt of S.targets){
          if (!tgt.shown && Math.abs(elapsed - tgt.at) <= S.rsvpInterval){
            digit = tgt.digit; tgt.shown=true; break;
          }
        }
        S.rsvpShown[digit] = 1;
        S.currentDigit = digit;
        S.phaseFrame = 0;
        S.log.push({pid:S.pid, type:'RSVP', round:S.roundIndex, roundName:cfg.name, ts:Math.round(elapsed), digit});
      }

      // draw inside the box
      ctx.clearRect(0,0,cw,ch);
      if (S.currentDigit!==null && S.phaseFrame < SHOW_FRAMES){
        drawDigit(S.currentDigit);
      } else {
        drawMask();
      }
      S.phaseFrame = (S.phaseFrame + 1) % (SHOW_FRAMES + MASK_FRAMES);

      S.rafId = requestAnimationFrame(loop);
    }
    S.rafId = requestAnimationFrame(loop);
  }

  // ===== AFTER ROUND =====
  function postRound(cfg, runDuration){
    const nTargetsShown = new Set(S.targets.filter(t=>t.shown).map(t=>t.digit)).size;
    S.roundMeta[S.roundIndex] = { nTargetsShown };
    S.log.push({pid:S.pid, type:'ROUND_META', round:S.roundIndex, roundName:cfg.name, nTargetsShown});
    S.log.push({pid:S.pid, type:'ROUND_END', round:S.roundIndex, roundName:cfg.name, ts:Math.round(now()-S.roundStart)});

    const uniqTargets = Array.from(new Set(S.targets.filter(t=>t.shown).map(t=>t.digit)));
    const unseen = []; for (let d=1; d<=20; d++){ if (!S.rsvpShown[d]) unseen.push(d); }
    if (unseen.length===0){ for (let d=1; d<=20; d++){ if (!uniqTargets.includes(d)) unseen.push(d); } }
    const probe = (uniqTargets.length>0)
      ? {digit: sample(uniqTargets), isTarget:true}
      : {digit: sample(unseen.length?unseen:[randint(1,20)]), isTarget:false};

    yesNoProbe(probe, ()=> afterRoundSequence(cfg, runDuration));
  }

  function yesNoProbe(probe, done){
    cancelLoop(); clearKeyHandler();
    screen.innerHTML = html`
      <h1>Did you see this number?</h1>
      <div class="center mid" style="margin:16px 0">${probe.digit}</div>
      <p class="center hint">Press <strong>F</strong> = Yes, <strong>J</strong> = No</p>`;
    const start = now();
    setKeyHandler([YES_KEY, NO_KEY], 20000, code=>{
      const rt = Math.round(now()-start);
      const respYes = code===YES_KEY ? 1 : code===NO_KEY ? 0 : null;
      const correct = respYes===null ? 0 : (respYes===1 ? (probe.isTarget?1:0) : (probe.isTarget?0:1));
      S.log.push({
        pid:S.pid, type:'PROBE', round:S.roundIndex,
        probe_digit: probe.digit, is_target: probe.isTarget?1:0,
        resp_yes: respYes, correct
      });
      done();
    });
  }

  // ===== Likerts =====
  function askLikert(title, labels, keyset, logType, valueField, next){
    cancelLoop(); clearKeyHandler();
    screen.innerHTML = html`
      <h1>${title}</h1>
      <div class="row" style="justify-content:center; gap:8px; flex-wrap:wrap;">
        ${labels.map(l=>`<span class="pill">${l}</span>`).join("")}
      </div>
      <p class="center hint">Press 1..${labels.length}</p>`;
    const t0 = now();
    setKeyHandler(keyset, 20000, code=>{
      const v = code ? (keyset.indexOf(code)+1) : null;
      const rt = Math.round(now()-t0);
      const rec = {pid:S.pid, type:logType, round:S.roundIndex, ts:Math.round(now()-S.roundStart), rt};
      if (valueField) rec[valueField] = v; else rec.val = v;
      S.log.push(rec);
      next();
    });
  }

  function afterRoundSequence(cfg, runDuration){
    askLikert("Confidence (1..5)", LABELS_CONF_5, LIKERT5, "CONF", "confidence", ()=> {
      askLikert("How concentrated were you? (1..5)", LABELS_CONC_5, LIKERT5, "FLOW_CONC", "concentration", ()=> {
        askLikert("I lost track of time (1..5)", LABELS_LOST_5, LIKERT5, "FLOW_LOST", "lost_time", ()=> {
          timeTwoAFC(cfg, runDuration);
        });
      });
    });
  }

  // ===== TIME 2AFC =====
  function timeTwoAFC(cfg, runDuration){
    cancelLoop(); clearKeyHandler();
    const actualSec = Math.round(runDuration/1000);
    const DELTAS = [15,16,18,20,22,25,30,35,40,45];
    let delta = sample(DELTAS); if (Math.random()<0.5) delta = -delta;
    let foilSec = actualSec + delta;
    foilSec = Math.max(15, Math.min(60, foilSec));
    if (Math.abs(foilSec - actualSec) < 15){
      foilSec = (actualSec <= 30) ? Math.min(60, actualSec + 15) : Math.max(15, actualSec - 15);
    }
    if (foilSec === actualSec){
      foilSec = (actualSec + 15 <= 60) ? actualSec + 15 : actualSec - 15;
    }

    const leftIsCorrect = Math.random()<0.5;
    const L = leftIsCorrect ? actualSec : foilSec;
    const R = leftIsCorrect ? foilSec : actualSec;

    screen.innerHTML = html`
      <h1>How long did that round last?</h1>
      <div class="two">
        <div class="choice" id="left">${L} sec</div>
        <div class="choice" id="right">${R} sec</div>
      </div>
      <p class="center hint">Press <strong>F</strong> (left) or <strong>J</strong> (right)</p>`;
    const start = now();
    setKeyHandler([LEFT_KEY, RIGHT_KEY], 20000, code=>{
      const rt = Math.round(now()-start);
      const pickLeft = code===LEFT_KEY ? 1 : code===RIGHT_KEY ? 0 : null;
      const chosen = pickLeft===null ? null : (pickLeft ? L : R);
      const correct = chosen===null ? 0 : (chosen===actualSec ? 1 : 0);
      S.log.push({
        pid:S.pid, type:'TIME_2AFC', round:S.roundIndex,
        left:L, right:R, leftIsCorrect:leftIsCorrect?1:0, choice_left:pickLeft, chosen, correct, rt
      });
      startNextRound();
    });
  }

  // ===== DEMOGRAPHICS =====
  function demographics(){
    cancelLoop(); clearKeyHandler(); S.phase='demo';
    screen.innerHTML = html`
      <h1>Quick Survey</h1>
      <p class="tiny center">Please answer the following. Your responses are recorded with your ID.</p>
      <div class="form-row">
        <label style="min-width:80px;">Gender</label>
        <label class="opt"><input type="radio" name="gender" value="Male"> Male</label>
        <label class="opt"><input type="radio" name="gender" value="Female"> Female</label>
        <label class="opt"><input type="radio" name="gender" value="Other"> Other</label>
      </div>
      <div class="form-row">
        <label style="min-width:80px;" for="age">Age</label>
        <input id="age" type="number" min="10" max="120" placeholder="e.g., 21"/>
      </div>
      <div class="form-row">
        <label style="min-width:80px;" for="race">Race</label>
        <select id="race">
          <option value="">Select…</option>
          <option>White</option>
          <option>Black or African American</option>
          <option>Asian</option>
          <option>American Indian or Alaska Native</option>
          <option>Native Hawaiian or Other Pacific Islander</option>
          <option>Other</option>
        </select>
        <input id="raceOther" type="text" placeholder="If Other, please specify" style="display:none; width:320px;"/>
      </div>
      <div class="center" style="margin-top:16px">
        <button class="btn" id="submitDemo">Continue</button>
      </div>
    `;

    const raceSel = document.getElementById('race');
    const raceOther = document.getElementById('raceOther');
    raceSel.addEventListener('change', ()=>{
      raceOther.style.display = (raceSel.value === 'Other') ? 'inline-block' : 'none';
    });

    document.getElementById('submitDemo').onclick = ()=>{
      const gender = (Array.from(document.querySelectorAll('input[name="gender"]'))
                       .find(x=>x.checked)?.value) || "";
      const age = (document.getElementById('age').value || "").trim();
      let race = raceSel.value || "";
      if (race === 'Other') {
        const extra = raceOther.value.trim();
        race = extra ? 'Other: '+extra : 'Other';
      }
      if (!gender || !age || !race){
        alert("Please answer Gender, Age, and Race to continue.");
        return;
      }
      S.demo = { gender, age, race };
      S.log.push({ pid:S.pid, type:'DEMO', gender, age, race });
      finish();
    };
  }

  // ===== FINISH & CSVs (events + wide single-row) =====
  function finish(){
    cancelLoop(); clearKeyHandler();

    // 1) Events CSV
    const cols = ["pid","round","roundName","type","ts","digit","probe_digit","is_target","resp_yes","correct","confidence","concentration","lost_time","seconds","bpm","rsvpHz","plannedMs","left","right","leftIsCorrect","choice_left","chosen","demo_gender","demo_age","demo_race"];
    const lines = [cols.join(",")];
    for (const r of S.log){
      const row = {
        pid:r.pid ?? S.pid, round:r.round ?? "", roundName:r.roundName ?? "", type:r.type ?? "", ts:r.ts ?? "",
        digit:r.digit ?? "", probe_digit:r.probe_digit ?? "", is_target:r.is_target ?? "", resp_yes:r.resp_yes ?? "",
        correct:r.correct ?? "", confidence:r.confidence ?? "", concentration:r.concentration ?? "", lost_time:r.lost_time ?? "",
        seconds:r.seconds ?? "", bpm:r.bpm ?? "", rsvpHz:r.rsvpHz ?? "", plannedMs:r.plannedMs ?? "",
        left:r.left ?? "", right:r.right ?? "", leftIsCorrect:r.leftIsCorrect ?? "", choice_left:r.choice_left ?? "", chosen:r.chosen ?? "",
        demo_gender:S.demo.gender || "", demo_age:S.demo.age || "", demo_race:S.demo.race || ""
      };
      lines.push(cols.map(k=>row[k]).join(","));
    }
    const csvEvents = lines.join("\n");
    const urlEvents = URL.createObjectURL(new Blob([csvEvents],{type:'text/csv'}));
    const fnameEvents = `flow_rsvp_events_${S.pid||'anon'}.csv`;

    // 2) Wide single-row summary (no duplicate consts)
    const rounds=[0,1,2];
    const w={};
    for (const i of rounds){
      const rows = S.log.filter(x=>x.round===i);
      const roundName = rows.find(x=>x.roundName)?.roundName || "";
      const plannedMs = rows.find(x=>x.type==="ROUND_START")?.plannedMs || "";
      const actualMs  = rows.find(x=>x.type==="ROUND_END")?.ts || "";
      const bpm       = rows.find(x=>x.type==="ROUND_START")?.bpm ?? "";
      const rsvpHz    = rows.find(x=>x.type==="ROUND_START")?.rsvpHz ?? "";
      const taps      = rows.filter(x=>x.type==="TAP").length;
      const beats     = rows.filter(x=>x.type==="BEAT").length;
      const targets   = rows.find(x=>x.type==="ROUND_META")?.nTargetsShown ?? "";
      const probe     = rows.find(x=>x.type==="PROBE");
      const conf      = rows.find(x=>x.type==="CONF")?.confidence ?? "";
      const conc      = rows.find(x=>x.type==="FLOW_CONC")?.concentration ?? "";
      const lost      = rows.find(x=>x.type==="FLOW_LOST")?.lost_time ?? "";
      const t2        = rows.find(x=>x.type==="TIME_2AFC");
      Object.assign(w, {
        [`r${i+1}_name`]:roundName,
        [`r${i+1}_planned_sec`]:plannedMs?Math.round(plannedMs/1000):"",
        [`r${i+1}_actual_sec`]:actualMs?Math.round(actualMs/1000):"",
        [`r${i+1}_bpm`]:bpm, [`r${i+1}_rsvp_hz`]:rsvpHz,
        [`r${i+1}_taps`]:taps, [`r${i+1}_beats`]:beats, [`r${i+1}_targets`]:targets,
        [`r${i+1}_probe_digit`]:probe?.probe_digit ?? "",
        [`r${i+1}_probe_is_target`]:probe?.is_target ?? "",
        [`r${i+1}_probe_yes`]:probe?.resp_yes ?? "",
        [`r${i+1}_probe_correct`]:probe?.correct ?? "",
        [`r${i+1}_conf`]:conf, [`r${i+1}_conc`]:conc, [`r${i+1}_lost`]:lost,
        [`r${i+1}_time_left`]:t2?.left ?? "", [`r${i+1}_time_right`]:t2?.right ?? "",
        [`r${i+1}_time_choice_left`]:t2?.choice_left ?? "",
        [`r${i+1}_time_chosen`]:t2?.chosen ?? "",
        [`r${i+1}_time_correct`]:t2?.correct ?? ""
      });
    }
    function avg(arr){
      const nums = arr.map(x=>x===""?null:Number(x)).filter(x=>x!==null && !Number.isNaN(x));
      return nums.length? (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(3) : "";
    }
    const wideCols=[
      "participant_id","demo_gender","demo_age","demo_race",
      "r1_name","r1_planned_sec","r1_actual_sec","r1_bpm","r1_rsvp_hz","r1_taps","r1_beats","r1_targets","r1_probe_digit","r1_probe_is_target","r1_probe_yes","r1_probe_correct","r1_conf","r1_conc","r1_lost","r1_time_left","r1_time_right","r1_time_choice_left","r1_time_chosen","r1_time_correct",
      "r2_name","r2_planned_sec","r2_actual_sec","r2_bpm","r2_rsvp_hz","r2_taps","r2_beats","r2_targets","r2_probe_digit","r2_probe_is_target","r2_probe_yes","r2_probe_correct","r2_conf","r2_conc","r2_lost","r2_time_left","r2_time_right","r2_time_choice_left","r2_time_chosen","r2_time_correct",
      "r3_name","r3_planned_sec","r3_actual_sec","r3_bpm","r3_rsvp_hz","r3_taps","r3_beats","r3_targets","r3_probe_digit","r3_probe_is_target","r3_probe_yes","r3_probe_correct","r3_conf","r3_conc","r3_lost","r3_time_left","r3_time_right","r3_time_choice_left","r3_time_chosen","r3_time_correct",
      "total_actual_sec","total_taps","total_beats","total_targets","mean_conf","mean_conc","mean_lost","mean_probe_correct","mean_time_correct"
    ];
    const wideValues=[
      S.pid, S.demo.gender||"", S.demo.age||"", S.demo.race||"",
      // r1
      w.r1_name||"", w.r1_planned_sec||"", w.r1_actual_sec||"", w.r1_bpm||"", w.r1_rsvp_hz||"",
      w.r1_taps||"", w.r1_beats||"", w.r1_targets||"",
      w.r1_probe_digit||"", w.r1_probe_is_target||"", w.r1_probe_yes||"", w.r1_probe_correct||"",
      w.r1_conf||"", w.r1_conc||"", w.r1_lost||"",
      w.r1_time_left||"", w.r1_time_right||"", w.r1_time_choice_left||"", w.r1_time_chosen||"", w.r1_time_correct||"",
      // r2
      w.r2_name||"", w.r2_planned_sec||"", w.r2_actual_sec||"", w.r2_bpm||"", w.r2_rsvp_hz||"",
      w.r2_taps||"", w.r2_beats||"", w.r2_targets||"",
      w.r2_probe_digit||"", w.r2_probe_is_target||"", w.r2_probe_yes||"", w.r2_probe_correct||"",
      w.r2_conf||"", w.r2_conc||"", w.r2_lost||"",
      w.r2_time_left||"", w.r2_time_right||"", w.r2_time_choice_left||"", w.r2_time_chosen||"", w.r2_time_correct||"",
      // r3
      w.r3_name||"", w.r3_planned_sec||"", w.r3_actual_sec||"", w.r3_bpm||"", w.r3_rsvp_hz||"",
      w.r3_taps||"", w.r3_beats||"", w.r3_targets||"",
      w.r3_probe_digit||"", w.r3_probe_is_target||"", w.r3_probe_yes||"", w.r3_probe_correct||"",
      w.r3_conf||"", w.r3_conc||"", w.r3_lost||"",
      w.r3_time_left||"", w.r3_time_right||"", w.r3_time_choice_left||"", w.r3_time_chosen||"", w.r3_time_correct||"",
      // aggregates
      (Number(w.r1_actual_sec||0)+Number(w.r2_actual_sec||0)+Number(w.r3_actual_sec||0)),
      (Number(w.r1_taps||0)+Number(w.r2_taps||0)+Number(w.r3_taps||0)),
      (Number(w.r1_beats||0)+Number(w.r2_beats||0)+Number(w.r3_beats||0)),
      (Number(w.r1_targets||0)+Number(w.r2_targets||0)+Number(w.r3_targets||0)),
      avg([w.r1_conf,w.r2_conf,w.r3_conf]),
      avg([w.r1_conc,w.r2_conc,w.r3_conc]),
      avg([w.r1_lost,w.r2_lost,w.r3_lost]),
      avg([w.r1_probe_correct,w.r2_probe_correct,w.r3_probe_correct]),
      avg([w.r1_time_correct,w.r2_time_correct,w.r3_time_correct])
    ];
    const wideCsv=[wideCols.join(","), wideValues.join(",")].join("\n");
    const urlWide=URL.createObjectURL(new Blob([wideCsv],{type:'text/csv'}));
    const fnameWide=`flow_rsvp_participant_summary_${S.pid||'anon'}.csv`;

    screen.innerHTML = `
      <h1>Finished 🎉</h1>
      <p class="center">Thanks for participating.</p>
      <div class="center" style="margin-top:16px">
        <a class="btn" id="dlEvents" download="${fnameEvents}">Download events CSV</a>
        <a class="btn" id="dlWide" style="margin-left:8px" download="${fnameWide}">Download participant summary (wide)</a>
      </div>`;
    document.getElementById('dlEvents').href=urlEvents;
    document.getElementById('dlWide').href=urlWide;
  }

  // go
  pidPrompt();
})();
</script>
</body>
</html>
