<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flow Tapper + Peripheral RSVP (2AFC + Confidence)</title>
<style>
  :root { --bg:#0b1117; --fg:#e6edf3; --muted:#9aa7b2; --accent:#6aa6ff; }
  html,body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--fg); font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
  #app { display:flex; align-items:center; justify-content:center; height:100%; }
  .card { width:min(900px,92vw); border:1px solid #243041; border-radius:16px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,.25); background:linear-gradient(180deg,#0e1520 0%,#0b1117 100%); }
  h1 { margin:0 0 6px 0; font-size:22px; color:#d5e2f0; }
  p { color:var(--muted); line-height:1.5; }
  .center { text-align:center; }
  .mid { font-size:36px; }
  .hint { font-size:14px; color:#93a0ad; }
  .pill { padding:8px 12px; border-radius:999px; border:1px solid #253447; color:#cfe0f6; }
  .layout { position:relative; height:60vh; min-height:420px; display:flex; align-items:center; justify-content:center; border:1px dashed #263346; border-radius:16px; margin:20px 0; }
  .rsvp { position:absolute; right:24px; top:16px; font-size:56px; color:#b7c3cf; opacity:.35; user-select:none; }
  .dot { width:84px; height:84px; border-radius:50%; background:#6aa6ff; opacity:.35; transition:transform .08s, opacity .08s; transform:scale(1); }
  .dot.flash { opacity:.95; transform:scale(1.08); }
  .btn { display:inline-block; background:#1a2634; border:1px solid #2a3a50; color:#d7e6fb; padding:10px 14px; border-radius:10px; cursor:pointer; }
  .btn:hover{ filter:brightness(1.1);}  
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  .choice { padding:16px; border:1px solid #2b3a53; border-radius:12px; text-align:center; font-size:54px; cursor:pointer; user-select:none; }
  .choice:hover { outline:2px solid #3b4f70; }
  .foot { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; }
</style>
</head>
<body>
<div id="app"><div class="card"><div id="screen"></div></div></div>
<script>
(function(){
  // ===== CONFIG =====
  const BLOCKS = [
    {name:"Easy",   bpm:60,  rsvpHz:10, durationMs:30000},
    {name:"Medium", bpm:90,  rsvpHz:14, durationMs:30000},
    {name:"Hard",   bpm:120, rsvpHz:20, durationMs:30000},
  ];
  // Random block duration range (participant cannot see this)
  const BLOCK_DURATION_RANGE_MS = [30000, 180000]; // 30s .. 180s

  const TARGETS_PER_BLOCK = 6;
  const TARGET_FIRST_MS = [3000,5000];
  const TARGET_GAP_MS = [7000,11000];
  const CONF_KEYS = ["Digit1","Digit2","Digit3","Digit4"];
  const FLOW_KEYS = ["Digit1","Digit2","Digit3","Digit4","Digit5"];
  const CHOICE_LEFT = "KeyF";
  const CHOICE_RIGHT= "KeyJ";

  // ===== STATE =====
  const S = { phase:"intro", blockIndex:-1, rafId:0, keyHandler:null, keyTimeout:null, 
    blockStart:0, endAt:0, nextBeatAt:0, beatInterval:600, nextRSVPAt:0, rsvpInterval:100, 
    targets:[],
    rsvpShown:new Array(10).fill(0),
    log:[]
  };

  // ===== UTILS =====
  const now = ()=>performance.now();
  const randint = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
  const sample  = arr => arr[Math.floor(Math.random()*arr.length)];
  const screen = document.getElementById('screen');
  const html   = (s,...v)=> s.map((x,i)=> x + (v[i]??'')).join('');

  window.addEventListener('keydown', e=>{ if (typeof S.keyHandler==='function') S.keyHandler(e); });
  function setKeyHandler(allowed, ms, cb){
    clearKeyHandler();
    S.keyHandler = e=>{
      if (!allowed || allowed.includes(e.code)) { clearKeyHandler(); cb(e.code); }
    };
    if (ms>0) S.keyTimeout = setTimeout(()=>{ clearKeyHandler(); cb(null); }, ms);
  }
  function clearKeyHandler(){ if (S.keyTimeout){ clearTimeout(S.keyTimeout); S.keyTimeout=null; } S.keyHandler=null; }
  function cancelLoop(){ if (S.rafId){ cancelAnimationFrame(S.rafId); S.rafId=0; } }

  function scheduleTargets(duration){
    const out=[];
    let t = randint(...TARGET_FIRST_MS);
    for (let i=0;i<TARGETS_PER_BLOCK;i++){
      out.push({at:t, digit:randint(0,9), shown:false});
      t += randint(...TARGET_GAP_MS);
      if (t>duration-1000) break;
    }
    return out;
  }

  function intro(){
    cancelLoop(); clearKeyHandler(); S.phase='intro';
    screen.innerHTML = html`
      <h1>Tap the dot in rhythm</h1>
      <p>Press <strong>SPACE</strong> whenever the dot flashes. Keep your eyes on the dot and play naturally; digits will also flash in the top‑right. Don’t try to track them on purpose—we’ll test what slipped in after each round.</p>
      <div class="layout"><div class="rsvp">7</div><div class="dot" id="dot"></div></div>
      <div class="center"><button class="btn" id="start">Start</button></div>
      <div class="row" style="display:flex;justify-content:center;gap:8px;margin-top:10px">
        <span class="pill">After each round: digit memory</span>
        <span class="pill">Confidence 1–4</span>
        <span class="pill">Flow + time estimate</span>
      </div>`;
    document.getElementById('start').onclick = ()=> startNextBlock();
  }

  function startNextBlock(){
    S.blockIndex++;
    if (S.blockIndex>=BLOCKS.length) return finish();
    runBlock(BLOCKS[S.blockIndex]);
  }

  function runBlock(cfg){
    cancelLoop(); clearKeyHandler(); S.phase='block';
    S.blockStart = now();
    const runDuration = randint(BLOCK_DURATION_RANGE_MS[0], BLOCK_DURATION_RANGE_MS[1]);
    S.endAt      = S.blockStart + runDuration;
    // log planned block meta
    S.log.push({type:'BLOCK_START', block:S.blockIndex, name:cfg.name, bpm:cfg.bpm, rsvpHz:cfg.rsvpHz, plannedMs:runDuration});
    S.beatInterval = 60000/cfg.bpm;
    S.nextBeatAt = S.blockStart + S.beatInterval;
    S.rsvpInterval= Math.max(40, Math.round(1000/cfg.rsvpHz));
    S.nextRSVPAt  = S.blockStart + S.rsvpInterval;
    S.targets     = scheduleTargets(runDuration);
    S.rsvpShown   = new Array(10).fill(0);

    screen.innerHTML = html`
      <div class="foot"><div class="pill">${cfg.name}</div><div class="hint">Press SPACE</div></div>
      <div class="layout"><div id="rsvp" class="rsvp"></div><div id="dot" class="dot"></div></div>`;
    const dot   = document.getElementById('dot');
    const elRSV = document.getElementById('rsvp');
    // no timer for participants

    setKeyHandler(["Space"], 0, (code)=>{
      const t = now();
      S.log.push({type:'TAP', block:S.blockIndex, ts:Math.round(t-S.blockStart)});
    });

    function loop(){
      const t = now();
      if (t>=S.endAt){ cancelLoop(); clearKeyHandler(); return postBlock(); }
      // timer hidden from participants

      while (t>=S.nextBeatAt){
        const jitter = 0.12;
        const base = S.beatInterval;
        const factor = 1 + (Math.random()*2-1)*jitter;
        S.nextBeatAt = t + base * factor;
        dot.classList.add('flash');
        setTimeout(()=>dot.classList.remove('flash'),120);
        S.log.push({type:'BEAT', block:S.blockIndex, ts:Math.round(t-S.blockStart)});
      }

      while (t>=S.nextRSVPAt){
        S.nextRSVPAt += S.rsvpInterval;
        let digit = randint(0,9);
        const elapsed = t - S.blockStart;
        for (const tgt of S.targets){
          if (!tgt.shown && Math.abs(elapsed - tgt.at) <= S.rsvpInterval){ digit=tgt.digit; tgt.shown=true; break; }
        }
        S.rsvpShown[digit] = 1;
        elRSV.textContent = digit;
        S.log.push({type:'RSVP', block:S.blockIndex, ts:Math.round(elapsed), digit});
      }

      S.rafId = requestAnimationFrame(loop);
    }
    S.rafId = requestAnimationFrame(loop);
  }

  function postBlock(){
    // mark end-of-block with actual duration
    S.log.push({type:'BLOCK_END', block:S.blockIndex, actualMs: Math.round(now() - S.blockStart)});

    const seen = S.targets.filter(t=>t.shown);
    let i=0; const next=()=>{ if (i>=seen.length) return postBlockSurvey(); twoAFC(seen[i++].digit, next); };
    next();
  }

  function twoAFC(correctDigit, done){
    cancelLoop(); clearKeyHandler();
    const candidates = [];
    for (let d=0; d<=9; d++) if (d!==correctDigit && !S.rsvpShown[d]) candidates.push(d);
    const foil = candidates.length ? candidates[Math.floor(Math.random()*candidates.length)] : ((d)=>{ let x=randint(0,9); if (x===d) x=(x+1)%10; return x; })(correctDigit);
    const leftIsCorrect = Math.random()<0.5;
    const L = leftIsCorrect ? correctDigit : foil;
    const R = leftIsCorrect ? foil : correctDigit;

    screen.innerHTML = html`
      <h1>Digit memory</h1>
      <div class="grid2"><div class="choice" id="left">${L}</div><div class="choice" id="right">${R}</div></div>
      <p class="center hint">Press <strong>F</strong> (left) or <strong>J</strong> (right)</p>`;

    const start = now();
    setKeyHandler([CHOICE_LEFT, CHOICE_RIGHT], 20000, code=>{
      const choice = code===CHOICE_LEFT ? L : code===CHOICE_RIGHT ? R : null;
      const rt = Math.round(now()-start);
      const correct = choice!==null ? (choice===correctDigit) : 0;
      S.log.push({type:'RECOG', block:S.blockIndex, correctDigit, foil, choice, leftIsCorrect, rt, correct});
      confidence(done);
    });
  }

  function confidence(next){
    cancelLoop(); clearKeyHandler();
    screen.innerHTML = html`
      <h1>Confidence (1–4)</h1>
      <div class="row" style="display:flex;justify-content:center;gap:8px">
        <span class="pill">1 Not</span><span class="pill">2 Slightly</span><span class="pill">3 Mostly</span><span class="pill">4 Very</span>
      </div>
      <p class="center hint">Press 1..4</p>`;
    const start = now();
    setKeyHandler(CONF_KEYS, 20000, code=>{
      const conf = code ? (CONF_KEYS.indexOf(code)+1) : null;
      const rt = Math.round(now()-start);
      S.log.push({type:'CONF', block:S.blockIndex, conf, rt});
      next();
    });
  }

  function postBlockSurvey(){
    cancelLoop(); clearKeyHandler();
    const qs = [
      'Challenge matched my skill (1..5)',
      'I was fully concentrated (1..5)',
      'I lost track of time (1..5)',
      'I enjoyed that round (1..5)'
    ];
    let i=0; const ask=()=>{
      if (i<qs.length){
        screen.innerHTML = html`<h1>After-round questions</h1><p class="center mid">${qs[i]}</p><p class="center hint">Press 1..5</p>`;
        setKeyHandler(FLOW_KEYS,20000, code=>{
          const val = code ? (FLOW_KEYS.indexOf(code)+1) : null;
          S.log.push({type:'FLOW', block:S.blockIndex, item:i+1, val});
          i++; ask();
        });
      } else { timeEstimate(); }
    };
    ask();
  }

  function timeEstimate(){
    cancelLoop(); clearKeyHandler();
    let typed='';
    const render=()=>{ screen.innerHTML = html`<h1>How many seconds did that round feel like?</h1><div class="center mid">${typed||'—'}</div><p class="center hint">Type 2–3 digits, then Enter</p>`; };
    render();
    S.keyHandler = (e)=>{
      if (/Digit[0-9]/.test(e.code) && typed.length<3){ typed += e.code.replace('Digit',''); render(); }
      else if (e.code==='Backspace'){ typed = typed.slice(0,-1); render(); }
      else if (e.code==='Enter'){ clearKeyHandler(); const val = typed?parseInt(typed,10):null; S.log.push({type:'TIME_EST', block:S.blockIndex, seconds:val}); startNextBlock(); }
    };
  }

  function finish(){
    cancelLoop(); clearKeyHandler();
    const cols=['type','block','ts','digit','choice','correct','conf','seconds'];
    const lines=[cols.join(',')];
    for (const r of S.log){
      const row={
        type:r.type||'', block:(r.block??''), ts:(r.ts??''), digit:(r.digit??''), choice:(r.choice??''), correct:(r.correct??''), conf:(r.conf??''), seconds:(r.seconds??'')
      };
      lines.push(cols.map(k=>row[k]).join(','));
    }
    const csv = lines.join('\n');
    const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    screen.innerHTML = html`<h1>Finished 🎉</h1><p class="center">Thanks for participating.</p><div class="center" style="margin-top:16px"><a class="btn" id="dl" download="flow_tap_rsvp_2afc.csv">Download results CSV</a></div>`;
    document.getElementById('dl').href = url;
  }

  intro();
})();
</script>
</body>
</html>
